<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raspberry Pi RC controller</title>

<style>
.flex-container {
    display: -webkit-flex;
    display: flex;
}
.control-button {
    border: 1px solid black;
    text-align: center;
    font-size: 300%;
}
</style>

</head>

<body id="body">
    <h1>Pi-RC controller</h1>

    <div class="flex-container" style="height: 200px;">
        <div class="flex-container" style="width: 50%; height: 100%; display: block;">
            <div id="forward" class="control-button" style="height: 50%; width: 100%; line-height: 100px;">ðŸ¡©</div>
            <div id="reverse" class="control-button" style="height: 50%; width: 100%; line-height: 100px;">ðŸ¡«</div>
        </div>
        <div class="flex-container" style="width: 50%;">
            <div id="left" class="control-button" style="height: 100%; width: 50%; line-height: 200px;">ðŸ¡¨</div>
            <div id="right" class="control-button" style="height: 100%; width: 50%; line-height: 200px;">ðŸ¡ª</div>
        </div>
    </div>

    <h2 id="server-heading">Server â–¼</h2>
    <div id="server-options">
    <table>
        <tr>
            <td>Server address</td>
            <td>
                <input id="server-address" autocomplete="on"/>
            </td>
        </tr>
        <tr>
            <td>Port</td>
            <td>
                <input id="port" type="number" value="12345"/>
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <button id="connect">Connect</button>
            </td>
        </tr>
    </table>
    </div>

    <h2 id="parameters-heading">Parameters â–¼</h2>
    <label for="parameter-file">
        <b>Load JSON parameter file</b>
        <input id="parameter-file" name="parameter-file" type="file" accept="application/json"/>
    </label>
    <div id="parameters-options">
    <table>
        <tr>
            <td>Frequency</td>
            <td>
                <input id="frequency" type="number" min="10" max="100" step="0.005" value="40.0"/>
            </td>
        </tr>
        <tr>
            <td>Synchronization burst microseconds</td>
            <td>
                <input id="sync-burst-us" type="number" min="50" max="10000" step="10" value="1200"/>
            </td>
        </tr>
        <tr>
            <td>Synchronization spacing microseconds</td>
            <td>
                <input id="sync-spacing-us" type="number" min="50" max="10000" step="10" value="400"/>
            </td>
        </tr>
        <tr>
            <td>Total synchronizations</td>
            <td>
                <input id="total-syncs" type="number" min="2" max="10" step="1" value="4"/>
            </td>
        </tr>
        <tr>
            <td>Signal burst microseconds</td>
            <td>
                <input id="signal-burst-us" type="number" min="50" max="10000" step="10" value="400"/>
            </td>
        </tr>
        <tr>
            <td>Signal spacing microseconds</td>
            <td>
                <input id="signal-spacing-us" type="number" min="50" max="10000" step="10" value="400"/>
            </td>
        </tr>
        <tr>
            <td>Forward</td>
            <td>
                <input id="forward" type="number" min="5" max="100" step="1" value="11"/>
            </td>
        </tr>
        <tr>
            <td>Forward left</td>
            <td>
                <input id="forward-left" type="number" min="5" max="100" step="1" value="27"/>
            </td>
        </tr>
        <tr>
            <td>Forward right</td>
            <td>
                <input id="forward-right" type="number" min="5" max="100" step="1" value="33"/>
            </td>
        </tr>
        <tr>
            <td>Reverse</td>
            <td>
                <input id="reverse" type="number" min="5" max="100" step="1" value="39"/>
            </td>
        </tr>
        <tr>
            <td>Reverse left</td>
            <td>
                <input id="reverse-left" type="number" min="5" max="100" step="1" value="51"/>
            </td>
        </tr>
        <tr>
            <td>Reverse right</td>
            <td>
                <input id="reverse-right" type="number" min="5" max="100" step="1" value="45"/>
            </td>
        </tr>
    </table>
    </div>

    <script type="text/javascript" charset="utf-8">

var socket = null;
var optionToId = {
    "frequency": "frequency",
    "synchronization_burst_us": "sync-burst-us",
    "synchronization_spacing_us": "sync-spacing-us",
    "total_synchronizations": "total-syncs",
    "signal_burst_us": "signal-burst-us",
    "signal_spacing_us": "signal-spacing-us",
    "total_synchronizations": "total-syncs"
};
var forward = reverse = false;
var left = right = false;

function loadFile(file) {
    var reader = new FileReader();
    reader.onload = function (e) {
        try {
            var json = JSON.parse(e.target.result);
        } catch (error) {
            alert("Unable to read JSON: " + error);
            return;
        }
        for (var option in optionToId) {
            if (optionToId.hasOwnProperty(option)) {
                value = json[option];
                if (value !== undefined) {
                    document.getElementById(optionToId[option]).value = value;
                }
            }
        }
    };
    reader.readAsText(file);
}
function handleFileSelect(evt) {
    evt.preventDefault();
    var file = evt.target.files[0];
    loadFile(file);
}
function connect(evt) {
    evt.preventDefault();
    if (socket !== null) {
        return;
    }
    var address = document.getElementById("server-address").value;
    var port = document.getElementById("port").value;
    socket = new WebSocket("ws://" + address + ":" + port);
    socket.onerror = function (evt) {
        alert("Unable to connect to the pi_pcm server; did you start it in TCP mode (--tcp)?");
        socket.close();
    };
    socket.onclose = function (evt) {
        socket = null;
    };
}
function formatControlMessage() {
    var frequency = parseFloat(document.getElementById("frequency").value);
    var deadFrequency = frequency > 40 ? 26.995 : 49.830;

    var command = [{
        "frequency": frequency,
        "dead_frequency": deadFrequency,
        "burst_us": parseFloat(document.getElementById("sync-burst-us").value),
        "spacing_us": parseInt(document.getElementById("sync-spacing-us").value),
        "repeats": parseInt(document.getElementById("total-syncs").value)
    }];

    var forwardCount = forward ? 2 : reverse ? 0 : 1;
    var leftCount = left ? 2 : right ? 0 : 1;
    var burstIdLookup = [
        ["reverse-right", "reverse", "reverse-left"],
        ["", "", ""],  // Not moving
        ["forward-right", "forward", "forward-left"]
    ];
    var burstId = burstIdLookup[forwardCount][leftCount];
    if (burstId !== "") {
        var burstSignals = parseInt(document.getElementById(burstId).value);
        command.push({
            "frequency": frequency,
            "dead_frequency": deadFrequency,
            "burst_us": parseFloat(document.getElementById("signal-burst-us").value),
            "spacing_us": parseInt(document.getElementById("sync-spacing-us").value),
            "repeats": burstSignals
        });
    }
    return JSON.stringify(command);
}
function sendControlMessage(evt) {
    if (evt !== undefined) {
        evt.preventDefault();
    }
    if (socket !== null) {
        socket.send(formatControlMessage());
    }
}
function keyHandler(evt, down) {
    evt = evt || window.evt;

    var key = evt.key || evt.which || evt.keyCode || evt.changedTouches[0].target;
    var needUpdate = false;  // We'll use this to ignore key repeats

    if (key === 38 || key === 'ArrowUp' || key === document.getElementById('forward')) {  // Up
        needUpdate = (forward !== down);
        forward = down;
    } else if (key === 40 || key === 'ArrowDown' || key === document.getElementById('reverse')) {  // Down
        needUpdate = (reverse !== down);
        reverse = down;
    } else if (key === 37 || key === 'ArrowLeft' || key === document.getElementById('left')) {  // Left
        needUpdate = (left !== down);
        left = down;
    } else if (key === 39 || key === 'ArrowRight' || key === document.getElementById('right')) {  // Right
        needUpdate = (right !== down);
        right = down;
    }
    if (needUpdate) {
        sendControlMessage();
        evt.preventDefault();
    }
}

function addToggleOptionsListener(headingId, optionsId) {
    document.getElementById(optionsId).style.display = 'none';
    document.getElementById(headingId).addEventListener('click', function() {
        var heading = document.getElementById(headingId);
        var text = heading.innerText;
        var options = document.getElementById(optionsId);
        if (options.style.display == 'none') {
            heading.innerText = text.substr(0, text.length - 1) + 'â–²';
            options.style.display = 'block';
        } else {
            heading.innerText = text.substr(0, text.length - 1) + 'â–¼';
            options.style.display = 'none';
        }
    }.bind(this));
}

addToggleOptionsListener('server-heading', 'server-options');
addToggleOptionsListener('parameters-heading', 'parameters-options');

document.getElementById("parameter-file").addEventListener("change", handleFileSelect);
document.getElementById("connect").addEventListener("click", connect);
document.getElementById("server-address").value = window.location.hostname;

['forward', 'reverse', 'left', 'right'].forEach(function (id) {
    var element = document.getElementById(id);
    ['mousedown', 'touchstart'].forEach(function (action) {
        element.addEventListener(action, function (evt) { keyHandler(evt, true); });
    });
    ['mouseup', 'touchend'].forEach(function (action) {
        element.addEventListener(action, function (evt) { keyHandler(evt, false); });
    });
});
var element = document.getElementById('body');
element.addEventListener('keydown', function (evt) { keyHandler(evt, true); });
element.addEventListener('keyup', function (evt) { keyHandler(evt, false); });

    </script>

</body>
</html>
